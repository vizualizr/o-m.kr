---
import "@styles/list.css";

import Paper from "@layouts/Paper.astro";
import { getFirstRevision, getRelativeTime } from "src/assets/scripts/utils";

import { getCollection } from "astro:content";

const articles = await getCollection("articles");

// Sort articles by latest revision
const sortedArticles = articles.sort((a, b) => {
  const getLatestTimestamp = (revisions: any[] | undefined) => {
    if (!Array.isArray(revisions) || revisions.length === 0) return null;
    return revisions.reduce((latest, current) =>
      new Date(current.timestamp) > new Date(latest.timestamp)
        ? current
        : latest,
    ).timestamp;
  };

  const latestA = getLatestTimestamp(a.data.revisions);
  const latestB = getLatestTimestamp(b.data.revisions);

  if (!latestA && !latestB) return 0;
  if (!latestA) return 1;
  if (!latestB) return -1;

  return new Date(latestB).getTime() - new Date(latestA).getTime();
});
---

<Paper title="news.app">
  <main class="">
    <ul class="">
      {
        sortedArticles.map((article) => (
          <li class="border-b border-gray-200 py-3 group">
            <a href={`/article/${article.data.slug}`} class="block">
              <div class="flex justify-between items-baseline mb-1">
                <h2 class="text-[20px] text-[#111111] font-semibold leading-tight hover:underline decoration-2 decoration-[#111111]/30">
                  {article.data.headline}
                </h2>
              </div>
              <div class="flex items-center gap-1 text-[14px] font-sans text-[#7a7a7a] mb-2">
                <time>
                  {getRelativeTime(
                    getFirstRevision(article.data.revisions).getTimestamp(),
                  )}
                </time>
              </div>
              <p class="text-[16px] text-[#7a7a7a] leading-snug line-clamp-2">
                {article.data.rubric}
              </p>
            </a>
          </li>
        ))
      }
    </ul>
    {
      sortedArticles.length === 0 && (
        <p class="text-center text-gray-500 mt-10">No articles found.</p>
      )
    }
  </main>
</Paper>
