---
import Paper from "@layouts/Paper.astro";
import CoverStories from "/src/components/CoverStories.astro";
import {
  getFirstRevision,
  getLastRevision,
  toDate,
  toKODate,
  getRelativeTimeDiff,
  getRelativeTime
} from "src/assets/scripts/utils";

import { getCollection } from "astro:content";

const articles = await getCollection("articles");

const coverStories = await getCollection(
  "articles",
  ({ data }) => data.highlight.listed === true
);
const coverStoriesSorted = coverStories
  .sort((a, b) => {
    const getLatestTimestamp = (revisions) => {
      if (!Array.isArray(revisions) || revisions.length === 0) return null;
      return revisions.reduce((latest, current) =>
        new Date(current.timestamp) > new Date(latest.timestamp)
          ? current
          : latest
      ).timestamp;
    };

    const indexA = a.data.highlight.index ?? 0;
    const indexB = b.data.highlight.index ?? 0;
    if (indexA !== indexB) return indexA - indexB;

    const latestA = getLatestTimestamp(a.data.revisions);
    const latestB = getLatestTimestamp(b.data.revisions);

    if (!latestA && !latestB) return 0;
    if (!latestA) return 1;
    if (!latestB) return -1;

    return new Date(latestB) - new Date(latestA);
  })
  .slice(0, 5);

const articleList = articles.filter(
  (article) =>
    article.data.slug &&
    !coverStoriesSorted.some((story) => story.data.slug === article.data.slug)
);
---

<Paper title="news.app">
  <main class="flex flex-col gap-10">
    <section>
      <h2 class="text-2xl">현재 표지 기사</h2>

      <ol>
        {
          coverStoriesSorted.map((coverStory) => (
            <li>
              <a href={`/article/${coverStory.data.slug}`}>
                <strong>{coverStory.data.headline}</strong>
              </a>
              취재: {coverStory.data.authors}
            </li>
          ))
        }
        {coverStoriesSorted.length === 0 && <p>No cover stories</p>}
      </ol>
    </section>



    {
      coverStoriesSorted.map((article, index) => (
        <a href={`/article/${article.data.slug}`}>
          <div class="relative flex size-96 flex-col overflow-hidden rounded-xl  saturate-55 hue-rotate-3 contrast-110 sepia-10">
            
            <img
              src={article.data?.images && article.data.images.length > 0 ? article.data.images[0].src : ""}
              alt="Background image"
              class="absolute inset-0 h-full w-full object-cover"
            />

            <div class="justify-right relative z-30 h-15 max-w-full flex-none items-start px-4 py-2 bg-gradient-to-b from-neutral-950/30 from-0% via-neutral-950/12 via-50% to-neutral-950/0 to-99% text-right">
              <time class="text-sm font-bold invert-100 opacity-70">
                {getRelativeTime(
                  getFirstRevision(article.data.revisions).getTimestamp()
                )}
              </time>
            </div>
            <div class="relative z-20 grow" />
            <div class="relative z-10 max-w-full flex-none items-end bg-gradient-to-t from-neutral-950/80 from-7% via-neutral-950/10 via-75% to-neutral-950/0 to-95%">
              <div class="mt-30 p-4 text-2xl font-bold text-white opacity-95 text-shadow-sm">
                <p>{article.data.headline}</p>
                <p class="text-sm font-normal">{article.data.rubric}</p>
              </div>
            </div>
          </div>
        </a>
      ))
    }

    <section>
      <h2 class="text-2xl">일반기사 목록</h2>
      <ul>
        {
          articleList.map((article, index) => (
            <li>
              <a href={`/article/${article.data.slug}`}>
                {index === 0 ? (
                  <strong>{article.data.headline}</strong>
                ) : (
                  article.data.headline
                )}
              </a>
              취재: {article.data.authors}
            </li>
          ))
        }
      </ul>
      {articleList.length === 0 && <p>No articles</p>}
    </section>

    <section class="hidden">
      <h2 class="">전체 기사 목록</h2>
      <ol>
        {
          articles.map((article) => (
            <li>
              <a href={`/article/${article.data.slug}`}>
                {article.data.headline}
              </a>{" "}
              취재: {article.data.authors}
            </li>
          ))
        }
      </ol>
      {
        articles.length === 0 && (
          <p>No articles found in the 'articles' collection.</p>
        )
      }
    </section>
  </main>
  <CoverStories stories={coverStoriesSorted} />
</Paper>
